name: Observability-Benchmarking

include:
  - ./obs.yml
  - ./utils.yml

x-default-environment:
  timezone: &default_timezone ${TIMEZONE:-Europe/Nicosia}
  host_repo: ${HOST_REPO:-C:/}
  cache_size: &default_cache_size ${CACHE_SIZE:-50000}
  cpu_limit: &default_cpu_limit ${CORES_LIMIT:-2}
  mem_limit: &default_mem_limit ${MEM_LIMIT:-512M}
  heap_min: ${HEAP_MIN:-96M}
  heap_max: ${HEAP_MAX:-96M}
  off_heap_max: ${OFF_HEAP_MAX:-32M}
  performance_cores: &default_performance_cores ${CORES_PRIMARY:-}
  ulimit: &default_ulimit ${ULIMIT:-1048576}
  pyroscope_agent_enabled: &default_pyroscope_agent_enabled ${PROFILING_AGENT:-false}
  metric_mm_http: &default_metric_mm_http ${METRIC_MM_HTTP:-true}
  metric_mm_jvm: &default_metric_mm_jvm ${METRIC_MM_JVM:-false}
  metric_mm_tomcat: &default_metric_mm_tomcat ${METRIC_MM_TOMCAT:-false}
  metric_otel_http: &default_metric_otel_http ${METRIC_OTEL_HTTP:-true}
  metric_otel_runtime: &default_metric_otel_runtime ${METRIC_OTEL_RUNTIME:-false}
  metric_otel_tomcat: &default_metric_otel_tomcat ${METRIC_OTEL_TOMCAT:-false}  # Does not seem to have an effect
  metric_otel_interval: &default_metric_otel_interval ${METRIC_OTEL_INTERVAL:-15000}
  spring_java_tool_options: &default_spring_java_tool_options "\
    -javaagent:/work/opentelemetry-javaagent.jar \
    -Dotel.javaagent.extensions=/work/pyroscope-otel-extension.jar \
    -Djava.security.egd=file:/dev/./urandom \
    -Djdk.tracePinnedThreads=full \
    -Dreactor.netty.ioWorkerCount=${CORES_LIMIT:-2} \
    -Dreactor.netty.ioSelectCount=-1 \
    -Dreactor.netty.native=true \
    -XX:+UnlockDiagnosticVMOptions \
    -XX:+AlwaysPreTouch \
    -XX:+DebugNonSafepoints \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:+PreserveFramePointer \
    -XX:+PrintNMTStatistics \
    -XX:+UseContainerSupport \
    -XX:+UseG1GC \
    -XX:+UseStringDeduplication \
    -XX:ActiveProcessorCount=${CORES_LIMIT:-2} \
    -XX:HeapDumpPath=/var/log/error \
    -XX:MaxGCPauseMillis=200 \
    -XX:MaxDirectMemorySize=${OFF_HEAP_MAX:-32M} \
    -XX:NativeMemoryTracking=summary \
    -XX:OnOutOfMemoryError=\"ts=$(date +%Y%m%d-%H%M%S) && echo OOM in PID %p at $$ts >> /var/log/error/oom.log && [ -f /var/log/error/java_pid%p.hprof ] && mv /var/log/error/java_pid%p.hprof /var/log/error/java_pid%p_$$ts.hprof\" \
    -Xms${HEAP_MIN:-96M} \
    -Xmx${HEAP_MAX:-96M} \
    --enable-native-access=ALL-UNNAMED \
    --sun-misc-unsafe-memory-access=allow \
    -Xlog:class+path=info \
    -Xlog:gc+init=info \
    -Xlog:gc+exit=info \
"
  quarkus_java_tool_options: &default_quarkus_java_tool_options "\
    -Djava.security.egd=file:/dev/./urandom \
    -Djdk.tracePinnedThreads=full \
    -XX:+UnlockDiagnosticVMOptions \
    -XX:+AlwaysPreTouch \
    -XX:+DebugNonSafepoints \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:+PreserveFramePointer \
    -XX:+PrintNMTStatistics \
    -XX:+UseContainerSupport \
    -XX:+UseG1GC \
    -XX:+UseStringDeduplication \
    -XX:ActiveProcessorCount=${CORES_LIMIT:-2} \
    -XX:HeapDumpPath=/var/log/error \
    -XX:MaxGCPauseMillis=200 \
    -XX:MaxDirectMemorySize=${OFF_HEAP_MAX:-32M} \
    -XX:NativeMemoryTracking=summary \
    -XX:OnOutOfMemoryError=\"ts=$(date +%Y%m%d-%H%M%S) && echo OOM in PID %p at $$ts >> /var/log/error/oom.log && [ -f /var/log/error/java_pid%p.hprof ] && mv /var/log/error/java_pid%p.hprof /var/log/error/java_pid%p_$$ts.hprof\" \
    -Xms${HEAP_MIN:-96M} \
    -Xmx${HEAP_MAX:-96M} \
    --enable-native-access=ALL-UNNAMED \
    --sun-misc-unsafe-memory-access=allow \
    -Xlog:class+path=info \
    -Xlog:gc+init=info \
    -Xlog:gc+exit=info \
"
  micronaut_java_tool_options: &default_micronaut_java_tool_options "\
    -Djava.security.egd=file:/dev/./urandom \
    -Djdk.tracePinnedThreads=full \
    -Dreactor.netty.ioWorkerCount=${CORES_LIMIT:-2} \
    -Dreactor.netty.ioSelectCount=-1 \
    -Dreactor.netty.native=true \
    -XX:+UnlockDiagnosticVMOptions \
    -XX:+AlwaysPreTouch \
    -XX:+DebugNonSafepoints \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:+PreserveFramePointer \
    -XX:+PrintNMTStatistics \
    -XX:+UseContainerSupport \
    -XX:+UseG1GC \
    -XX:+UseStringDeduplication \
    -XX:ActiveProcessorCount=${CORES_LIMIT:-2} \
    -XX:HeapDumpPath=/var/log/error \
    -XX:MaxGCPauseMillis=200 \
    -XX:MaxDirectMemorySize=${OFF_HEAP_MAX:-32M} \
    -XX:NativeMemoryTracking=summary \
    -XX:OnOutOfMemoryError=\"ts=$(date +%Y%m%d-%H%M%S) && echo OOM in PID %p at $$ts >> /var/log/error/oom.log && [ -f /var/log/error/java_pid%p.hprof ] && mv /var/log/error/java_pid%p.hprof /var/log/error/java_pid%p_$$ts.hprof\" \
    -Xms${HEAP_MIN:-96M} \
    -Xmx${HEAP_MAX:-96M} \
    --add-opens=java.base/java.lang=ALL-UNNAMED \
    --enable-native-access=ALL-UNNAMED \
    --sun-misc-unsafe-memory-access=allow \
    -Xlog:class+path=info \
    -Xlog:gc+init=info \
    -Xlog:gc+exit=info \
"
  #   -XX:+UseZGC \
  #   -XX:+UseG1GC \
  #   -XX:+PrintFlagsFinal \
  #   -XX:MaxRAMPercentage=80.0 \
  #   -XX:MinRAMPercentage=80.0 \
  #   -XX:NativeMemoryTracking=off|sumary|detail \
  #   -Xlog:gc* \
  #   -Xlog:gc*:stdout:time,uptime,level,tags \
  #   -Xlog:gc,gc+heap,gc+ergo=info:stdout:time,uptime,level,tags
  #   -Xlog:gc*,safepoint:file=gc-z.log:time,uptime,level,tags
  #   -Xlog:gc*,safepoint:file=gc-g1.log:time,uptime,level,tags
###################################################
  native_java_options: &default_native_java_options
    - "-Xms${HEAP_MIN:-96M}"
    - "-Xmx${HEAP_MAX:-96M}"
    - "-XX:ActiveProcessorCount=${CORES_LIMIT:-2}"
    - "-XX:MaxGCPauseMillis=200"                      #Enterprise
    - "-XX:MaxDirectMemorySize=${OFF_HEAP_MAX:-32M}"  #Enterprise
    - "-XX:+ExitOnOutOfMemoryError"
    - "-XX:+HeapDumpOnOutOfMemoryError"
    - "-XX:HeapDumpPath=/var/log/error"
#      - "-XX:+ReportFatalErrorOnOutOfMemoryError"
#      - "-XX:+PrintGC"
#      - "-XX:+PrintGCSummary"           #Community
#      - "-XX:+PrintGCTimes"             #Community
#      - "-XX:PrintFlags=Debug" #Expert, Debug, User
#      - "-XX:+VerboseGC"
###################################################

x-common-properties: &common_properties
  restart: no
  pull_policy: never
  cpus: *default_cpu_limit
  cpuset: *default_performance_cores
  mem_limit: *default_mem_limit
  mem_reservation: *default_mem_limit
  deploy:
    resources:
      limits:
        cpus: *default_cpu_limit
        memory: *default_mem_limit
      reservations:
        cpus: *default_cpu_limit
        memory: *default_mem_limit
  ulimits:
    nofile:
      soft: *default_ulimit
      hard: *default_ulimit
  depends_on:
    - alloy

######### Potential for OTEL fine-tuning #########
#      OTEL_BLRP_MAX_EXPORT_BATCH_SIZE: 512
#      OTEL_BLRP_MAX_QUEUE_SIZE: 2048
#      OTEL_BLRP_SCHEDULE_DELAY: 5000         # ms between exports
#      OTEL_BLRP_EXPORT_TIMEOUT: 30000        # ms
#      OTEL_BSP_EXPORT_TIMEOUT: 30000
#      OTEL_BSP_MAX_EXPORT_BATCH_SIZE: 512
#      OTEL_BSP_MAX_QUEUE_SIZE: 2048
#      OTEL_BSP_SCHEDULE_DELAY: "5s" #Default 5s
#      OTEL_METRIC_EXPORT_TIMEOUT: 30000
###################################################
# See also
#   https://opentelemetry.io/docs/specs/otel/configuration/sdk-environment-variables/
#   https://opentelemetry.io/docs/zero-code/java/agent/disable/#suppressing-specific-agent-instrumentation
#   https://quarkus.io/guides/opentelemetry
#   https://quarkus.io/guides/opentelemetry-metrics

services:
  spring-jvm-tomcat-platform:
    profiles: ["${DOCKER_PROF_SPRING_JVM_TOMCAT_PLATFORM:-skip}"]
    image: spring-jvm-tomcat-platform:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-jvm-tomcat:${SPRING_BOOT_VERSION}_latest
        PROFILE: tomcat
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-jvm-tomcat-platform
    ports:
      - "8080:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/jvm/tomcat/platform/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-jvm-tomcat-platform
      SERVER_TOMCAT_MBEANREGISTRY_ENABLED: *default_metric_mm_tomcat
      SPRING_JMX_ENABLED: false
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      SPRING_THREADS_VIRTUAL_ENABLED: false
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true
      MANAGEMENT_METRICS_ENABLE_TOMCAT: *default_metric_mm_tomcat

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_INSTRUMENTATION_TOMCAT_ENABLED: *default_metric_otel_tomcat
      OTEL_SERVICE_NAME: "spring-jvm-tomcat-platform"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/spring-jvm-tomcat-platform"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer" # itimer, cpu, wall
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  spring-jvm-tomcat-virtual:
    profiles: ["${DOCKER_PROF_SPRING_JVM_TOMCAT_VIRTUAL:-skip}"]
    image: spring-jvm-tomcat-virtual:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-jvm-tomcat:${SPRING_BOOT_VERSION}_latest
        PROFILE: tomcat
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-jvm-tomcat-virtual
    ports:
      - "8081:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/jvm/tomcat/virtual/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-jvm-tomcat-virtual
      SERVER_TOMCAT_MBEANREGISTRY_ENABLED: *default_metric_mm_tomcat
      SPRING_JMX_ENABLED: false
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      SPRING_THREADS_VIRTUAL_ENABLED: true
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true
      MANAGEMENT_METRICS_ENABLE_TOMCAT: *default_metric_mm_tomcat

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_INSTRUMENTATION_TOMCAT_ENABLED: *default_metric_otel_tomcat
      OTEL_SERVICE_NAME: "spring-jvm-tomcat-virtual"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/spring-jvm-tomcat-virtual"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  spring-jvm-netty:
    profiles: ["${DOCKER_PROF_SPRING_JVM_NETTY:-skip}"]
    image: spring-jvm-netty:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-jvm-netty:${SPRING_BOOT_VERSION}_latest
        PROFILE: netty
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-jvm-netty
    ports:
      - "8082:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/jvm/netty/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-jvm-netty
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      SPRING_THREADS_VIRTUAL_ENABLED: false
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "spring-jvm-netty"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/spring-jvm-netty"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  spring-native-tomcat-platform:
    profiles: ["${DOCKER_PROF_SPRING_NATIVE_TOMCAT_PLATFORM:-skip}"]
    image: spring-native-tomcat-platform:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/native/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-native-tomcat-platform:${SPRING_BOOT_VERSION}_latest
        PROFILE: tomcat
        VIRTUAL_ENABLED: false
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-native-tomcat-platform
    ports:
      - "8083:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/native/tomcat/platform/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-native-tomcat-platform
      SERVER_TOMCAT_MBEANREGISTRY_ENABLED: false
      SPRING_JMX_ENABLED: false
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true
      MANAGEMENT_METRICS_ENABLE_TOMCAT: *default_metric_mm_tomcat

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_INSTRUMENTATION_TOMCAT_ENABLED: *default_metric_otel_tomcat
      OTEL_SERVICE_NAME: "spring-native-tomcat-platform"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=native,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
    entrypoint:
      - "./spring-native-tomcat-platform"
    command: *default_native_java_options
    <<: *common_properties

  spring-native-tomcat-virtual:
    profiles: ["${DOCKER_PROF_SPRING_NATIVE_TOMCAT_VIRTUAL:-skip}"]
    image: spring-native-tomcat-virtual:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/native/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-native-tomcat-virtual:${SPRING_BOOT_VERSION}_latest
        PROFILE: tomcat
        VIRTUAL_ENABLED: true
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-native-tomcat-virtual
    ports:
      - "8084:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/native/tomcat/virtual/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-native-tomcat-virtual
      SERVER_TOMCAT_MBEANREGISTRY_ENABLED: false
      SPRING_JMX_ENABLED: false
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true
      MANAGEMENT_METRICS_ENABLE_TOMCAT: *default_metric_mm_tomcat

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_INSTRUMENTATION_TOMCAT_ENABLED: *default_metric_otel_tomcat
      OTEL_SERVICE_NAME: "spring-native-tomcat-virtual"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=native,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
    entrypoint:
      - "./spring-native-tomcat-virtual"
    command: *default_native_java_options
    <<: *common_properties

  spring-native-netty:
    profiles: ["${DOCKER_PROF_SPRING_NATIVE_NETTY:-skip}"]
    image: spring-native-netty:${SPRING_BOOT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spring/native/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spring-native-netty:${SPRING_BOOT_VERSION}_latest
        PROFILE: netty
        VIRTUAL_ENABLED: false
        SPRING_BOOT_VERSION: ${SPRING_BOOT_VERSION}
    container_name: spring-native-netty
    ports:
      - "8085:8080"
    volumes:
      - ${HOST_REPO}/data/services/spring/native/netty/error:/var/log/error
    environment:
      TZ: *default_timezone
      SPRING_APPLICATION_NAME: spring-native-netty
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MANAGEMENT_METRICS_ENABLE_EXECUTOR: false
      MANAGEMENT_METRICS_ENABLE_HTTP_SERVER_REQUESTS: *default_metric_mm_http
      MANAGEMENT_METRICS_ENABLE_JVM: *default_metric_mm_jvm
      MANAGEMENT_METRICS_ENABLE_PROCESS: true
      MANAGEMENT_METRICS_ENABLE_SYSTEM: true

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "spring-native-netty"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=native,webengine.name=Spring Boot,webengine.version=${SPRING_BOOT_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
    entrypoint:
      - "./spring-native-netty"
    command: *default_native_java_options
    <<: *common_properties

  quarkus-jvm:
    profiles: ["${DOCKER_PROF_QUARKUS_JVM:-skip}"]
    image: quarkus-jvm:${QUARKUS_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: quarkus/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: quarkus-jvm:${QUARKUS_VERSION}_latest
        QUARKUS_VERSION: ${QUARKUS_VERSION}
    container_name: quarkus-jvm
    ports:
      - "8086:8080"
    volumes:
      - ${HOST_REPO}/data/services/quarkus/jvm/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_quarkus_java_tool_options
      QUARKUS_LOG_LEVEL: "info"
      CACHE_SIZE: *default_cache_size

      OTEL_SDK_DISABLED: false
      QUARKUS_OTEL_SDK_DISABLED: false
      QUARKUS_OTEL_LOGS_LEVEL: "info"
      QUARKUS_OTEL_INSTRUMENT_HTTP_SERVER_METRICS: *default_metric_otel_http
      QUARKUS_OTEL_INSTRUMENT_VERTX_HTTP: true                                # turns off tracing if disabled
      QUARKUS_OTEL_INSTRUMENT_JVM_METRICS: *default_metric_otel_runtime       # seems to add 10-20% overhead
      QUARKUS_OTEL_SERVICE_NAME: "quarkus-jvm"
      QUARKUS_OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,telemetry.distro.name=quarkus-micrometer-opentelemetry"
      QUARKUS_OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      QUARKUS_OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      QUARKUS_OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
    <<: *common_properties
    ########  Otel Java Agent approach (alternative)  ########
#      OTEL_SDK_DISABLED: true
#      OTEL_LOG_LEVEL: "info"
#      OTEL_JAVAAGENT_DEBUG: false
#      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
#      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
#      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metrics_jvm_on
#      OTEL_INSTRUMENTATION_JAXRS_ENABLED: true               # shows the missing route GET /hello/reactive
#      OTEL_INSTRUMENTATION_NETTY_ENABLED: true
#      OTEL_INSTRUMENTATION_QUARKUS_ENABLED: true
#      OTEL_INSTRUMENTATION_VERTX_WEB_ENABLED: true
#      OTEL_SERVICE_NAME: "quarkus-jvm"
#      OTEL_RESOURCE_ATTRIBUTES: "env=dev,runtime=jvm,webengine.name=Quarkus,webengine.version=${QUARKUS_VERSION}"
#      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
#      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
#      OTEL_TRACES_EXPORTER: "otlp"
#      OTEL_METRICS_EXPORTER: "otlp"
#      OTEL_LOGS_EXPORTER: "otlp"
#      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
#      OTEL_TRACES_SAMPLER: "parentbased_always_on" #"always_on"

#      OTEL_PROFILING_ENABLED: true
#      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
#      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
#      OTEL_PYROSCOPE_START_PROFILING: true
#      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
#      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
#      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
#      PYROSCOPE_APPLICATION_NAME: "agent/quarkus-jvm"
#      PYROSCOPE_PROFILING_INTERVAL: "10ms"
#      PYROSCOPE_UPLOAD_INTERVAL: "20s"
#      PYROSCOPE_PROFILER_LOCK: "10ms"
#      PYROSCOPE_PROFILER_ALLOC: "512k"
#      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
#      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
#      PYROSCOPE_FORMAT: "jfr"
#      PYROSCOPE_PROFILER_EVENT: "itimer"
#      PYROSCOPE_ALLOC_LIVE: false
#      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
#      PYROSCOPE_LOG_LEVEL: "warn"
#      PYROSCOPE_GC_BEFORE_DUMP: false
########################################################

  quarkus-native:
    profiles: ["${DOCKER_PROF_QUARKUS_NATIVE:-skip}"]
    image: quarkus-native:${QUARKUS_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: quarkus/native/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: quarkus-native:${QUARKUS_VERSION}_latest
        QUARKUS_VERSION: ${QUARKUS_VERSION}
    container_name: quarkus-native
    ports:
      - "8087:8080"
    volumes:
      - ${HOST_REPO}/data/services/quarkus/native/error:/var/log/error
    #      - ../data/services/quarkus/native/jfr:/tmp
    environment:
      TZ: *default_timezone
      QUARKUS_LOG_LEVEL: "info"
      CACHE_SIZE: *default_cache_size

      OTEL_SDK_DISABLED: false
      QUARKUS_OTEL_SDK_DISABLED: false
      QUARKUS_OTEL_LOGS_LEVEL: "info"
      QUARKUS_OTEL_INSTRUMENT_HTTP_SERVER_METRICS: *default_metric_otel_http
      QUARKUS_OTEL_INSTRUMENT_VERTX_HTTP: true                              # turns off tracing if disabled
      QUARKUS_OTEL_INSTRUMENT_JVM_METRICS: *default_metric_otel_runtime     # seems to add 10-20% overhead
      QUARKUS_OTEL_SERVICE_NAME: "quarkus-native"
      QUARKUS_OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=native,telemetry.distro.name=quarkus-micrometer-opentelemetry"
      QUARKUS_OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      QUARKUS_OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      QUARKUS_OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
    entrypoint:
      - "./quarkus-native"
    command: *default_native_java_options
#      - "-XX:+FlightRecorder"
#      - "-XX:StartFlightRecording=disk=true,filename=/tmp/recording.jfr,settings=profile,dumponexit=true,maxsize=100M,maxage=1h"
#      - "-XX:FlightRecorderOptions=repository=/tmp/jfr"
    <<: *common_properties

  spark-jvm-platform:
    profiles: ["${DOCKER_PROF_SPARK_JVM_PLATFORM:-skip}"]
    image: spark-jvm-platform:${SPARK_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spark/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spark-jvm:${SPARK_VERSION}_latest
        SPARK_VERSION: ${SPARK_VERSION}
    container_name: spark-jvm-platform
    ports:
      - "8088:8080"
    volumes:
      - ${HOST_REPO}/data/services/spark/jvm/platform/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size
      THREAD_MODE: platform
      LOG_METERS: true

      # Spark/Jetty tuning
      JETTY_MAX_THREADS: ${SPARK_JETTY_MAX_THREADS:-0}
      JETTY_MIN_THREADS: ${SPARK_JETTY_MIN_THREADS:-0}
      JETTY_ACCEPT_QUEUE_SIZE: ${SPARK_JETTY_ACCEPT_QUEUE_SIZE:-10000}
      JETTY_IDLE_TIMEOUT_MS: ${SPARK_JETTY_IDLE_TIMEOUT_MS:-60000}
      SPARK_HANDLER_EXECUTION_MODE: ${SPARK_HANDLER_EXECUTION_MODE:-direct}
      SPARK_PLATFORM_EXECUTOR_THREADS: ${SPARK_PLATFORM_EXECUTOR_THREADS:-0}

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "spark-jvm-platform"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=SparkJava,webengine.version=${SPARK_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/spark-jvm-platform"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  spark-jvm-virtual:
    profiles: ["${DOCKER_PROF_SPARK_JVM_VIRTUAL:-skip}"]
    image: spark-jvm-virtual:${SPARK_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: spark/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: spark-jvm:${SPARK_VERSION}_latest
        SPARK_VERSION: ${SPARK_VERSION}
    container_name: spark-jvm-virtual
    ports:
      - "8089:8080"
    volumes:
      - ${HOST_REPO}/data/services/spark/jvm/virtual/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size
      THREAD_MODE: virtual
      LOG_METERS: true

      # Spark/Jetty tuning
      JETTY_MAX_THREADS: ${SPARK_JETTY_MAX_THREADS:-0}
      JETTY_MIN_THREADS: ${SPARK_JETTY_MIN_THREADS:-0}
      JETTY_ACCEPT_QUEUE_SIZE: ${SPARK_JETTY_ACCEPT_QUEUE_SIZE:-10000}
      JETTY_IDLE_TIMEOUT_MS: ${SPARK_JETTY_IDLE_TIMEOUT_MS:-60000}
      SPARK_HANDLER_EXECUTION_MODE: ${SPARK_HANDLER_EXECUTION_MODE:-direct}
      SPARK_VIRTUAL_EXECUTION_MODE: ${SPARK_VIRTUAL_EXECUTION_MODE:-spark}
      SPARK_PLATFORM_EXECUTOR_THREADS: ${SPARK_PLATFORM_EXECUTOR_THREADS:-0}

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "spark-jvm-virtual"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=SparkJava,webengine.version=${SPARK_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/spark-jvm-virtual"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  javalin-jvm-platform:
    profiles: ["${DOCKER_PROF_JAVALIN_JVM_PLATFORM:-skip}"]
    image: javalin-jvm-platform:${JAVALIN_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: javalin/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: javalin-jvm:${JAVALIN_VERSION}_latest
        JAVALIN_VERSION: ${JAVALIN_VERSION}
    container_name: javalin-jvm-platform
    ports:
      - "8090:8080"
    volumes:
      - ${HOST_REPO}/data/services/javalin/jvm/platform/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size
      THREAD_MODE: platform
      LOG_METERS: true

      # Javalin/Jetty tuning
      JETTY_MAX_THREADS: ${JAVALIN_JETTY_MAX_THREADS:-0}
      JETTY_MIN_THREADS: ${JAVALIN_JETTY_MIN_THREADS:-0}
      JETTY_ACCEPT_QUEUE_SIZE: ${JAVALIN_JETTY_ACCEPT_QUEUE_SIZE:-10000}
      JETTY_IDLE_TIMEOUT_MS: ${JAVALIN_JETTY_IDLE_TIMEOUT_MS:-60000}
      JAVALIN_HANDLER_EXECUTION_MODE: ${JAVALIN_HANDLER_EXECUTION_MODE:-direct}
      JAVALIN_PLATFORM_EXECUTOR_THREADS: ${JAVALIN_PLATFORM_EXECUTOR_THREADS:-0}

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "javalin-jvm-platform"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Javalin,webengine.version=${JAVALIN_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/javalin-jvm-platform"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  javalin-jvm-virtual:
    profiles: ["${DOCKER_PROF_JAVALIN_JVM_VIRTUAL:-skip}"]
    image: javalin-jvm-virtual:${JAVALIN_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: javalin/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: javalin-jvm:${JAVALIN_VERSION}_latest
        JAVALIN_VERSION: ${JAVALIN_VERSION}
    container_name: javalin-jvm-virtual
    ports:
      - "8091:8080"
    volumes:
      - ${HOST_REPO}/data/services/javalin/jvm/virtual/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_spring_java_tool_options
      LOGGING_LEVEL_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size
      THREAD_MODE: virtual
      LOG_METERS: true

      # Javalin/Jetty tuning
      JETTY_MAX_THREADS: ${JAVALIN_JETTY_MAX_THREADS:-0}
      JETTY_MIN_THREADS: ${JAVALIN_JETTY_MIN_THREADS:-0}
      JETTY_ACCEPT_QUEUE_SIZE: ${JAVALIN_JETTY_ACCEPT_QUEUE_SIZE:-10000}
      JETTY_IDLE_TIMEOUT_MS: ${JAVALIN_JETTY_IDLE_TIMEOUT_MS:-60000}
      JAVALIN_HANDLER_EXECUTION_MODE: ${JAVALIN_HANDLER_EXECUTION_MODE:-direct}
      JAVALIN_PLATFORM_EXECUTOR_THREADS: ${JAVALIN_PLATFORM_EXECUTOR_THREADS:-0}

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_JAVAAGENT_DEBUG: false
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "javalin-jvm-virtual"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Javalin,webengine.version=${JAVALIN_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"

      OTEL_PROFILING_ENABLED: true
      OTEL_PYROSCOPE_ADD_PROFILE_URL: true
      OTEL_PYROSCOPE_ADD_PROFILE_BASELINE_URL: true
      OTEL_PYROSCOPE_START_PROFILING: true
      OTEL_PYROSCOPE_ADD_SPAN_NAME: true
      PYROSCOPE_OTEL_ADD_PROFILE_ID: true
      PYROSCOPE_AGENT_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_APPLICATION_NAME: "agent/javalin-jvm-virtual"
      PYROSCOPE_PROFILING_INTERVAL: "10ms"
      PYROSCOPE_UPLOAD_INTERVAL: "20s"
      PYROSCOPE_PROFILER_LOCK: "10ms"
      PYROSCOPE_PROFILER_ALLOC: "512k"
      PYROSCOPE_EXPORT_COMPRESSION_LEVEL_JFR: "BEST_SPEED"
      PYROSCOPE_JAVA_STACK_DEPTH_MAX: "2048"
      PYROSCOPE_FORMAT: "jfr"
      PYROSCOPE_PROFILER_EVENT: "itimer"
      PYROSCOPE_ALLOC_LIVE: false
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_LOG_LEVEL: "warn"
      PYROSCOPE_GC_BEFORE_DUMP: false
    <<: *common_properties

  micronaut-jvm:
    profiles: ["${DOCKER_PROF_MICRONAUT_JVM:-skip}"]
    image: micronaut-jvm:${MICRONAUT_VERSION}_latest
    build:
      context: ../services/java
      dockerfile: micronaut/jvm/Dockerfile
      args:
        BUILDKIT_BUILD_NAME: micronaut-jvm:${MICRONAUT_VERSION}_latest
        MICRONAUT_VERSION: ${MICRONAUT_VERSION}
    container_name: micronaut-jvm
    ports:
      - "8092:8080"
    volumes:
      - ${HOST_REPO}/data/services/micronaut/jvm/error:/var/log/error
    environment:
      TZ: *default_timezone
      JAVA_TOOL_OPTIONS: *default_micronaut_java_tool_options
      LOGGER_LEVELS_ROOT: "INFO"
      CACHE_SIZE: *default_cache_size

      MICRONAUT_EXECUTORS_PLATFORM_CORE_POOL_SIZE: *default_cpu_limit
      MICRONAUT_EXECUTORS_PLATFORM_NUMBER_OF_THREADS: *default_cpu_limit
      MICRONAUT_EXECUTORS_PLATFORM_PARALLELISM: *default_cpu_limit
      MICRONAUT_EXECUTORS_PLATFORM_NTHREADS: *default_cpu_limit
        #SCHEDULED, CACHED, FIXED, WORK_STEALING, THREAD_PER_TASK
      MICRONAUT_EXECUTORS_PLATFORM_TYPE: "FIXED"
        #SCHEDULED, CACHED, FIXED, WORK_STEALING, THREAD_PER_TASK
      MICRONAUT_EXECUTORS_VIRTUAL_TYPE: "THREAD_PER_TASK"
      #Experimentally, seems to bump virtual threads performance by 15%
      MICRONAUT_NETTY_EVENT_LOOPS_DEFAULT_LOOM_CARRIER: ${MICRONAUT_LOOM_CARRIER:-true}
      MICRONAUT_NETTY_EVENT_LOOPS_DEFAULT_NUM_THREADS: *default_cpu_limit
      #AUTO, MANUAL, IO, BLOCKING
      MICRONAUT_SERVER_THREAD_SELECTION: "MANUAL"

      MICRONAUT_METRICS_BINDERS_JVM_ENABLED: *default_metric_mm_jvm
      MICRONAUT_METRICS_BINDERS_PROCESSOR_ENABLED: true
      MICRONAUT_METRICS_BINDERS_UPTIME_ENABLED: false
      MICRONAUT_METRICS_BINDERS_FILES_ENABLED: false
      MICRONAUT_METRICS_BINDERS_LOGBACK_ENABLED: false
      MICRONAUT_METRICS_BINDERS_WEB_ENABLED: true
      MICRONAUT_METRICS_ENABLED: true

      OTEL_SDK_DISABLED: false
      OTEL_LOG_LEVEL: "info"
      OTEL_INSTRUMENTATION_COMMON_DEFAULT_ENABLED: true
      OTEL_INSTRUMENTATION_EXECUTORS_ENABLED: true
      OTEL_INSTRUMENTATION_MICROMETER_ENABLED: true
      OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED: *default_metric_otel_runtime
      OTEL_SERVICE_NAME: "micronaut-jvm"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=caffeine,env=dev,runtime=jvm,webengine.name=Micronaut,webengine.version=${MICRONAUT_VERSION},loom.carrier=${MICRONAUT_LOOM_CARRIER}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
    <<: *common_properties

  go:
    profiles: ["${DOCKER_PROF_GO:-skip}"]
    image: go:${GO_VERSION}_latest
    build:
      context: ../services/go/enhanced
      dockerfile: Dockerfile
      args:
        BUILDKIT_BUILD_NAME: go:${GO_VERSION}_latest
        GO_VERSION: ${GO_VERSION}
    container_name: go
    ports:
      - "9080:8080"
    environment:
      TZ: *default_timezone
      GOMAXPROCS: *default_cpu_limit
      #      GOMEMLIMIT: "${HEAP_MAX}iB"
      GOGC: 200
      LOG_LEVEL: "info"
      CACHE_SIZE: *default_cache_size
      CACHE_IMPL: "theine"                            # "slice", "map", "ristretto", "theine", "otter"

      OTEL_SERVICE_NAME: "go"
      OTEL_RESOURCE_ATTRIBUTES: "cache.impl=theine,env=dev,runtime=native,webengine.name=Go,webengine.version=${GO_VERSION}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "alloy:4317"
      OTEL_EXPORTER_OTLP_INSECURE: true
      OTEL_LOGS_ENABLED: true
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
      OTEL_TRACES_SAMPLER_ARG: 1                            # applicable for 'traceidratio' sampler
      OTEL_METRICS_ENABLED: true
      OTEL_METRIC_EXPORT_INTERVAL: *default_metric_otel_interval
      OTEL_RUNTIME_METRICS_ENABLED: *default_metric_otel_runtime
      OTEL_GO_SCHEDULE_METRICS_ENABLED: *default_metric_otel_runtime
      OTEL_HTTP_ENABLED: true
      OTEL_HTTP_TRACES_ENABLED: true
      OTEL_HTTP_TRACES_MODE: "otelfiber"                    # 'otelfiber' (close to java services), 'minimal' (much faster but unfair comparison)
      OTEL_HTTP_SPAN_NAME_MODE: "method_route"              # 'constant' (fastest) → "http.request", 'method', 'route', 'path', 'method_route' (close to java services), 'method_path'
      OTEL_HTTP_PROPAGATION_ENABLED: true
      OTEL_HTTP_METRICS_ENABLED: *default_metric_otel_http  # shows oob 'http_server*' metrics
      OTEL_HTTP_COLLECT_CLIENT_IP: false
      OTEL_HTTP_IGNORE_PATHS: "/healthz,/readyz,/livez"
      APP_HANDLER_SPANS_ENABLED: false
      PYROSCOPE_ENABLED: *default_pyroscope_agent_enabled
      PYROSCOPE_SERVER_ADDRESS: "http://pyroscope:4040"
      PYROSCOPE_APPLICATION_NAME: "agent/go"
      PYROSCOPE_PROFILE_TYPES: "cpu,alloc,inuse,goroutines,mutex,block"
      PYROSCOPE_UPLOAD_INTERVAL: 20s
      PYROSCOPE_LOG_LEVEL: "warn"
    <<: *common_properties

  go-simple:
    profiles: ["${DOCKER_PROF_GO_SIMPLE:-skip}"]
    image: go-simple:${GO_VERSION}_latest
    build:
      context: ../services/go/simple
      dockerfile: Dockerfile
      args:
        BUILDKIT_BUILD_NAME: go-simple:${GO_VERSION}_latest
        GO_VERSION: ${GO_VERSION}
    container_name: go-simple
    ports:
      - "9081:8080"
    environment:
      TZ: *default_timezone
      GOMAXPROCS: *default_cpu_limit
      #      GOMEMLIMIT: "${HEAP_MAX}iB"
      OTEL_EXPORTER_OTLP_ENDPOINT: "alloy:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "go-simple"
      OTEL_RESOURCE_ATTRIBUTES: "env=dev,runtime=native,webengine.name=Go,webengine.version=${GO_VERSION}"
    <<: *common_properties