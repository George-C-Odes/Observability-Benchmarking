import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock the orchestrator submit so we can assert the command generated by the API route.
vi.mock('@/lib/orchestratorClient', () => {
  return {
    submitCommand: vi.fn(async () => ({ jobId: 'job-1' })),
  };
});

import { submitCommand } from '@/lib/orchestratorClient';
import { POST } from './route';

function makeRequest(body: unknown): Request {
  return new Request('http://localhost/api/docker/control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
}

describe('/api/docker/control', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('builds start command', async () => {
    const res = await POST(makeRequest({ service: 'grafana', action: 'start' }) as unknown as never);

    expect(submitCommand).toHaveBeenCalledWith('docker compose up -d grafana');
    const json = (await res.json()) as { command?: string };
    expect(json.command).toBe('docker compose up -d grafana');
  });

  it('builds restart command', async () => {
    const res = await POST(makeRequest({ service: 'tempo', action: 'restart' }) as unknown as never);

    expect(submitCommand).toHaveBeenCalledWith('docker compose restart tempo');
    const json = (await res.json()) as { command?: string };
    expect(json.command).toBe('docker compose restart tempo');
  });

  it('builds recreate command via restart+forceRecreate', async () => {
    const res = await POST(
      makeRequest({ service: 'tempo', action: 'restart', forceRecreate: true }) as unknown as never
    );

    expect(submitCommand).toHaveBeenCalledWith('docker compose up -d --force-recreate tempo');
    const json = (await res.json()) as { command?: string };
    expect(json.command).toBe('docker compose up -d --force-recreate tempo');
  });

  it('builds stop+rm command when deleteContainer is true', async () => {
    const res = await POST(
      makeRequest({ service: 'orchestrator', action: 'stop', deleteContainer: true }) as unknown as never
    );

    expect(submitCommand).toHaveBeenCalledWith('docker compose stop orchestrator; docker compose rm -f orchestrator');
    const json = (await res.json()) as { command?: string };
    expect(json.command).toBe('docker compose stop orchestrator; docker compose rm -f orchestrator');
  });
});
